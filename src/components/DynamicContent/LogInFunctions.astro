---
// This is the frontmatter section where you can import other components or scripts if needed

//DOCS: https://github.com/netlify/netlify-identity-widget/tree/master


const { info } = Astro.props as Props;
---

<!-- ===================== -->
<!-- old netlify login code -->
<!-- ===================== -->
<script type="text/javascript">
  //function vars
  var functionsDelay = 3000; //time in ms
  //console.log(location);
  //console.log(location.href);
  //console.log(location.origin);

  //delay functions so there's no refresh loop 
  //on initial login event on page load.
  setTimeout(() => {
    //console.log("Netlify Login -- LogInFunctions ready")
    
    //Refresh on log in - basic version
    /*netlifyIdentity.on('login', user => 
      location.reload()
    );*/

    //Refresh on log in - advanced version
    //If current page is equal to base url, ie is this currently the home page?
    //extra slash "/" on href gets trimmed off for comparison
    if(location.href.slice(0, -1) == location.origin){
      //console.log("index page -- login redirect")
      netlifyIdentity.on('login', user => 
        location.replace("/en/introduction")
      );
    } else{
      //console.log("normal login reload")
      netlifyIdentity.on('login', user => 
        location.reload()
      );
    }

    //Refresh on log out
    netlifyIdentity.on('logout', () => 
      location.reload()
    );
  }, functionsDelay); //time in ms

</script>

<script type="text/javascript">
  /***** cookie-based login status *****/
  netlifyIdentity.on('login', user => 
    SessionManager.setItem('loggedIn', 'true')
  );
  netlifyIdentity.on('logout', () => 
    SessionManager.setItem('loggedIn', 'false')
  );
</script>


<!-- =================================== -->
<!-- ===== Frontegg Login Functions ===== -->
<!-- =================================== -->

<script>
  console.log("===== Frontegg Login  =====");

  /*===== import =====*/
    import {initialize} from "@frontegg/js"

  /*===== initialize Frontegg instance =====*/
    const app = initialize({
      contextOptions: {
        baseUrl: "https://app-60w042yz5etg.frontegg.com", //set your Frontegg environment domain and client ID here
        clientId: '22400201-214c-4be4-aa17-d66b72a2cce1'
      },
      hostedLoginBox: true
    })

  /*===== access Frontegg data =====*/
    app.store.subscribe(() => {
      const state = app.store.getState();
      setTimeout(() => {
        if (state.auth.user) {
            //logged in via Frontegg instance
            //document.getElementById('user-container').innerText = state.auth.user.email;
            console.log(state.auth.user);
            if (state.auth.isAuthenticated) {
              //USER IS LOGGED IN - via login function
              //styleHtml += '[fe-state="isAuthenticated"] { }';
              //styleHtml += '[fe-state="!isAuthenticated"] { display: none; }';
              //Custom site actions
              setLogin();
              window.location.replace('/en/introduction/');
            }  else  {
              //USER IS LOGGED OUT
              //styleHtml += '[fe-state="isAuthenticated"] { display: none; }';
              //styleHtml += '[fe-state="!isAuthenticated"] { }';
              //Custom site actions
              //SessionManager.setItem('loggedIn', 'false');
            }

          }else if(SessionManager.getItem('loggedIn') == 'true') {
            
            //already logged in via cookie

          } else {
            
            //not logged in

          }
      }, 0); //time in ms

      /*===== ======= =====*/
      /*===== ACTIONS =====*/
      /*===== ======= =====*/
          document.getElementById("loginWithRedirect").addEventListener('click', () => {
            console.log("login button click");
            app.loginWithRedirect()
          })

          document.getElementById("logout").addEventListener('click', () => {
            console.log("logout button clicked");
            clearLogin();
            app.logout()
            window.location.href = '/login'
          })

    });



    

</script>


<script type="text/javascript">
  
  function clearLogin(){
    SessionManager.setItem('loggedIn', 'false');
    SessionManager.setItem('userDataEmail', 'logged_out');
    SessionManager.setItem('userDataName', 'logged_out');
    SessionManager.setItem('userDataGroups', 'logged_out');
    SessionManager.setItem('userDataRoles', 'logged_out');
    //app.logout()
    window.location.href = '/login'
  }

  function setLogin(){
    SessionManager.setItem('loggedIn', 'true');
    SessionManager.setItem('userDataEmail', state.auth.user.email);
    SessionManager.setItem('userDataName', state.auth.user.name);
    SessionManager.setItem('userDataGroups', state.auth.user.groups);
    SessionManager.setItem('userDataRoles', state.auth.user.roles);
    //app.logout()
    window.location.href = '/login'
  }
  
</script>